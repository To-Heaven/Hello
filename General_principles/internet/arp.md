# ARP协议工作流程总结

#### 先说说以太网协议
- 以太网协议位于TCP/IP模型中的数据链路层，它利用发送方和接收方的`MAC地址`，通过广播的方式在局域网内进行数据包的传播。[详情看我前面的介绍](http://www.ziawang.com/article/210/)

- 以太网协议的结构

```
源MAC地址(48位2进制，6字节)  目标MAC地址  数据帧类型(0x0806，2字节)
```


## ARP协议

#### ARP协议是什么鬼？
- arp协议位于TCP/IP协议的网络层，它的作用是以广播的方式向局域网中的主机发送数据包，通过报文中目标主机的IP地址来定位出该主机的MAC地址。

#### 为啥要有ARP协议呢？
- 之所以使用arp协议是因为在以太网协议和TCP/IP协议之间存在一个矛盾：
	- 首先，以太网协议规定同一个局域网中的一台主机要和另一台主机通信必须要知道目标自己的Mac地址，因为以太网是通过广播的方式来传递信息的
	- 但是在TCP/IP协议中，网络层和传输层只关心目标主机的IP地址。
	- 因此，当在以太网中使用IP协议的时候，就必须先通过目标主机的IP地址解析出目标主机的MAC地址。

#### ARP缓存表
- 一张存放了`IP地址`和`MAC地址`映射关系的表，这张表存放在每台主机的ARP告诉缓存中

- 查看主机中的ARP表
	- Linux：`arp`命令
	- Windows：`arp -a`

```bash
# windows
C:\Users\ziawa>arp -a

接口: 192.168.20.50 --- 0x8
  Internet 地址         物理地址              类型
  192.168.20.21         bc-75-74-36-e0-9b     动态
  192.168.20.87         ec-d0-9f-c5-5d-5b     动态
  192.168.20.254        60-da-83-be-c2-5a     动态
  192.168.20.255        ff-ff-ff-ff-ff-ff     静态
  224.0.0.2             01-00-5e-00-00-02     静态
  224.0.0.22            01-00-5e-00-00-16     静态
  224.0.0.251           01-00-5e-00-00-fb     静态
  224.0.0.252           01-00-5e-00-00-fc     静态
  238.238.238.238       01-00-5e-6e-ee-ee     静态
  239.255.255.250       01-00-5e-7f-ff-fa     静态
  255.255.255.255       ff-ff-ff-ff-ff-ff     静态

接口: 192.168.11.1 --- 0xa
  Internet 地址         物理地址              类型
  192.168.11.254        00-50-56-f5-4d-dd     动态
  192.168.11.255        ff-ff-ff-ff-ff-ff     静态
  224.0.0.2             01-00-5e-00-00-02     静态
  224.0.0.22            01-00-5e-00-00-16     静态
  224.0.0.251           01-00-5e-00-00-fb     静态
  224.0.0.252           01-00-5e-00-00-fc     静态
  238.238.238.238       01-00-5e-6e-ee-ee     静态
  239.255.255.250       01-00-5e-7f-ff-fa     静态
  255.255.255.255       ff-ff-ff-ff-ff-ff     静态

接口: 192.168.180.1 --- 0x14
  Internet 地址         物理地址              类型
  192.168.180.254       00-50-56-f0-a2-c5     动态
  192.168.180.255       ff-ff-ff-ff-ff-ff     静态
  224.0.0.2             01-00-5e-00-00-02     静态
  224.0.0.22            01-00-5e-00-00-16     静态
  224.0.0.251           01-00-5e-00-00-fb     静态
  224.0.0.252           01-00-5e-00-00-fc     静态
  238.238.238.238       01-00-5e-6e-ee-ee     静态
  239.255.255.250       01-00-5e-7f-ff-fa     静态
  255.255.255.255       ff-ff-ff-ff-ff-ff     静态

C:\Users\ziawa>


# linux

[root@host ziawang]# arp
Address                  HWtype  HWaddress           Flags Mask            Iface
172.96.192.1.16clouds.c  ether   54:1e:56:6d:82:41   CM                    eth0
[root@host ziawang]# 

```


#### 通过ARP协议获取目标主机MAC地址的前提
- **必须得有目标主机的IP地址**


#### ARP实现的原理及流程
0. 发送方首先会在自己本地的ARP缓存表中查看是否有目标IP对应的MAC地址
	- 如果有目标MAC地址，就会**直接在以太网协议头中写入该目标MAC地址**，然后再发送
	- 如果arp缓存表中没有目标主机的MAC地址。，就会执行下面的步骤。

1. 发送方通过IP地址和子网掩码区分出自己所处的局域网
	- 如果发送方和接收方处于同一个局域网之内，**这个ARP进程就会在本局域网上广播发送一个`ARP请求分组`**，局域网中的其他主机在接收到这个`ARP分组`之后，在网络层就会查看该分组中的`目标IP地址`是否是本机的IP地址，如果是就会返回一个`ARP响应分组`，此时发送方获取到的就是目标主机的MAC地址，同时会更新自己本地的ARP缓存表，然后将目标主机MAC地址放在以太网头中，再以广播的方式发送数据包
	- 如果发送方和接收方不处于同一个局域网之内，那么获取到的就是发送方所在网络上路由器的MAC地址，同样也会更新自己本地的ARP缓存表，此时目标主机IP对应的是本地主机所在局域网中路由的MAC地址，发送方发送数据的时候就会将ARP缓存表中目标IP对应的路由MAC地址写入到以太网头中，再以广播的方式将数据包发送到路由，路由再将数据包转发给目标主机。

接收方的ARP响应
- 当接收端接收到发送端的帧之后，在网络层会获取ARP协议中的`目标IP地址`，如果发现这个IP地址和本机的IP地址相同，就会返回一个ARP应答给发送方，并将自己的mac地址写入到ARP应答包中，发送方接收到这个ARP应答包之后就会获取其中的目标mac地址，并将该mac地址写入到本地的mac表中。
- 注意
	1. 包含接收方的IP地址和mac地址
	2. ARP响应分组是`单播`，直接从一个源地址发送到目标地址，在这里则是接收方将`ARP响应分组`直接返回给发送方


###### ARP请求分组

```
源MAC地址 目标MAC地址FF:FF:FF:FF:FF:FF  源IP地址  目标IP地址  数据部分 
```


###### 关于ARP代理
- 看了一篇别人的实验，对我的理解非常有用：[代理ARP](https://www.cisco.com/support/zh/105/5.shtml)

- 当发送方和接收方不存在于同一个局域网中的时候，即使发送方知道了接收方的MAC地址也没法进行直接通信，必须通过路由转发才可以。此时发送方主机通过ARP协议获得的将是**子网中路由器的MAC地址**（更新ARP表），发送方所有要发送给目标主机的数据帧都需要先发送给该路由器，通过该路由其向外发送。
	- 当通过ARP协议获取了子网中路由的MAC地址之后，ARP表中目标IP地址就会对应上子网中这个路由的MAC地址，所以以后每次发送方主机向该目标IP发送信息的时候，都会先将数据包交给路由，再由路由来转发这个`IP数据报`。
	- 路由器接收到发送方的`IP数据报`之后，就会向其连接的另一个网络中的主机和路由发送`ARP请求分组`，如果恰好这个网络中存在目标IP地址，那么路由器通过目标主机返回的`ARP响应分组`获取目标主机的`mac地址`，再将数据报以广播的形式转发给这台主机；如果网络中没有找到这台主机，那么就会得到连接该网络的另一台路由器的`mac地址`，再由该路由器转发这个`IP数据报`，重复上述过程，最终将数据报交给目标IP所在的主机。