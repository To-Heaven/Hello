# 互联网协议

[点击查看我整理的网络协议思维导图](https://github.com/ZiaWang/Hello/blob/master/picture/internet_protocol.png?raw=true)

## 互联网协议（网络通讯原理）
> 就像语言一样，英语是世界上所有人之间相互通信的统一标准，如果把计算机看成分布世界各地的人，那么连接两台计算机之间的Internet实际上就是一系列的统一标准。计算机之间利用这些统一的标准来相互联系。这些统一的标准就是**互联网协议**		
>  互联网协议定义计算机如何接入Internet以及接入Internet的计算机通信的标准。   


-  ip地址用于找到目标主机的局域网
-  mac地址用于找到局域网中的具体主机
	-  ip可以通过arp协议获取mac地址，因此IP+port标识了全世界范围内独一无二的一个应用软件
-  tcp/udp基于端口的协议（一台机器上端口的范围0-65535，0-1023为操作系统占用的端口）
		-端口号可以确定一台机器上具体的软件


## Osi模型与Tcp/IP模型
- 互联网协议的理论模型就是Osi模型
	- 按照功能的不同，将Osi模型分为七层
		- 应用层 、表示层、 会话层（在Tcp/IP中合并为应用层）
		- 传输层
		- 网络层
		- 数据链路层
		- 物理层
- 在实际中，用到的模型是Tcp/IP模型五层（或四层）
		- 应用层  SMTP、ftp、telnet
		- 传输层（四层交换机，四层路由器）——解释数据
		- 网络层（路由器，三层交换机）——定位IP地址和确定链接路径
		- 数据链路层（网卡，交换机，网桥）——与硬件驱动对话
		- 物理层（光缆，集线器，双绞线，中继器， 无线电波）
### 物理层（整个开放系统的基础）
- 计算机网络Osi模型最低的一层
- 重要性：
	- 保证原始的数据可以在各种物理媒体上传输。
	- 为传输数据所需要的物理链路创建、维持、拆除，而提供具有机械的、电子的、功能的和规范的特性。
	- 孤立的计算机之间如果想要互相联系，就必须完成组网。
- 功能:
	- 基于电器特性发送高低频电压（电信号，高电压对应数字1，低电压对应数字0）
![](http://images2015.cnblogs.com/blog/1036857/201610/1036857-20161008154500754-704720294.png)
- 常见的物理层设备
	- 网卡、光纤、CAT-5线、串口、并口、repeater（加强信号）
### 数据链路层
- 单纯的电信号0和1是没有意义的，必须规定电信号多少位为一组，定义每组表示什么意思
- 功能：
	- 定义了物理层电信号的分组方式，将数据组合成"数据块"（帧，帧是数据链路层的传送单位）
	- 控制帧在物理信道上的传输，包括处理数据差错，调节发送速率以使与接收方相匹配
- 以太网协议Ethernet
	- 一组电信号构成一个数据包，叫做帧
	- 每一数据帧分成：报头head和数据data两部分
		- head固定18字节。包括
			- 发送者/源mac地址，6字节
			- 接收者/目标mac地址，6字节
			- 数据类型，6字节
		- data最短46字节，最长1500字节。包括
			-  数据包的具体内容
		- 64字节< head + data < 1518字节，超过1518就得分片发送
- mac地址
	- **Ethernet规定：接入Internet的设备都必须具备网卡。发送端和接收端的地址就是指网卡的地址，即mac地址**
	- mac地址是每块网卡在出厂时被烧制的唯一的地址。
	- 长度： 48位2进制，通常在网卡上由12位16进制来表示，其中前6位是厂商编号，后六位是流水线号
- **广播**
	- 通过arp协议（ip），一台主机可以获取另一台主机的mac地址
	- 有了mac地址，处于同一个局域网中的计算机就可以进行通信了。
	- ethernet 采用最原始的方式——广播进行通信。
		- 举个例子
		- PCa以广播的方式发送以太网包给PCb，然而处于同一个局域网中的PCc，PCd，PCe都能收到PCa发送的信息，超开之后发现目标mac地址不是自己PC网卡上的mac地址就舍弃信息，如果是自己的就相应该信息
		- ![](http://images2015.cnblogs.com/blog/1036857/201610/1036857-20161008171118317-164674895.png)
 	- 但是世界范围的互联网是由一个个小的局域网组成的，如果所有的通信都采用以太网的广播方式，那么一台电脑发送的以太网包全世界都能收到，这将会造成一种灾难。
 	- ![](http://images2015.cnblogs.com/blog/1036857/201610/1036857-20161008172732957-102296982.png)


### 网络层
- 功能：
	- 引入一套新的地址用来区分不同的广播域/子网（局域网），这套地址就是网络地址
- **arp协议**（根据IP地址获取物理地址的一个Tcp/IP协议）
> 计算机通信靠广播的方式，所有上层的包最终都要封装上以太网的报头，然后通过以太网协议发送。
> 通信是基于mac地址的广播方式，但是计算机在发包的时候，想要获取目标主机的mac就得通过arp协议来完成

- **条件：已知目标主机的IP地址**
- 过程：
	1. 通过IP地址和子网掩码区分出自己所在的子网
		- 同一子网：直接广播到目标主机mac（目标主机IP）
		- 不同子网：目标子网所在网关mac，通过arp协议访问目标IP
	2. 如果源IP地址和目标IP地址不在同一子网，那么arp协议会是下面这样，依次位源mac，目标mac，源ip，目标ip，最后是数据部分
		-  发送端mac地址  FF:FF:FF:FF:FF:FF  172.16.10.10/24  172.116.10.11/24 数据
	3. 这个包会以广播的方式在目标所处的子网内传输所有主机接收后拆开包，如果发现目标ip是自己的，就响应并返回自己的mac地址


- **IP协议**——规定了网络地址
	- 一段IP地址通常写成四段十进制数
	- IPV4协议规定网络地址由32位的2进制表示
		- 范围： 0.0.0.0---255.255.255.255
- IP地址
	- **单纯的IP地址只是标记了IP地址的种类，无法单纯从IP地址上辨识一个IP所处的子网，需要用到子网掩码才能进行判断**
	- 结构：
		- 网络部分：标识子网（局域网）
		- 主机部分：标识主机
- 子网掩码
	- 形式上类似于IP地址，也是四段十进制显示（本质上也是32位2进制数字）
	- 二进制中，网络部分全为1，主机部分全是0
	- 举个例子


```
IP地址172.16.10.1
已知网络部分是前24位，主机部分是后8位，那么子网掩码就是：
11111111.11111111.11111111.00000000    ==>   255.255.255.0
```

- 判断两个IP地址是否在同一个子网/局域网中
	- 将IP地址都还原成二进制的形式，分别与子网掩码进行“AND/与”运算，如果得出的结果相同，那么这两个IP地址就是在同一个子网中的。
	
- IP数据包
	- **直接放在以太网包的数据data部分**
	- 也分为head（20-60字节）和data（最大65515字节）



### 传输层
> tcp的可靠性与其双向链接无关，而是与其请求和确认的信息有关

- 功能：建立端口到端口的通信（端口范围65535，系统占用的是1023）
- **Tcp协议**（可靠的传输）
	- 也有head和data
		- head报头一共8个字节，理论上可以无限长
	- 结构：
		- 以太网头  ip头  tcp头  数据
	
- **UDP协议**（不可靠传输）
	- 报头部分也是8字节，总长度不超过65535字节
	- 结构：
		- 以太网头  ip头  udp头  数据

#### TCP的三次握手和四次挥手

- 三次握手
	1. 建立链接时，客户端发送SYN包(syn=x) 到服务器，并进入SYN_SEND状态，等待服务器确认
	2. 服务器收到SYN包，必须确认客户的SYN(ack=x+1)，自己也要发送一个SYN包(syn=y)，即SYN+ACK包，此时服务器进入了SYN_RECV状态
	3. 客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(syn=y+1)，此包发送完毕，客户端和服务端进入ESTABLISH状态，完成三次握手，客户端与服务器开始传送数据

- 四次挥手
	1. 客户端发送一个FIN包(x+2)和一个ACK包(y+1)，用来关闭从客户端到服务端的数据传送
	2. 服务器收到这个FIN包之后，返回一个ACK包(x+3)
	3. 服务器关闭客户端的链接，发送一个FIN包(y+1)给客户端
	4. 客户端发挥ACK包(y+2)确认，服务端与客户端断开链接


![](http://images2015.cnblogs.com/blog/1036857/201610/1036857-20161008185648160-191189690.png)
### 应用层
>TCP协议为各种各样的程序传递数据，比如Email，WWW，ftp等，因此需要有不同的协议规定电子邮件，网页，FTP数据的格式，这些应用程序协议构成了“应用层”。


- 规定应用程序的数据格式
- DNS服务器
	- 功能：将要访问的域名解析成IP地址


### 一个包的旅行
1. 开机后，通过DHCH服务自动获取IP地址、子网掩码、网管、DNS地址
2. （应用层） 打开浏览器之后，浏览器会询问本地DNS获取一个IP地址，并把域名换成IP地址，将端口添加到IP地址之后，浏览器利用HTTP协议将IP地址和端口封装到报头，将要访问的主机资源路径封装到数据，进入传输层
3.  （传输层)为应用层的包封装上tcp协议的报头和目标端口
4.  （网络层）为传输层的包封装IP协议的报头
5.  数据链路层给包封装上以太网协议的报头。
6.  物理层转换成电信号发送出去。
7.  经过网关和各级路由转发到目标ip的网关，再定位到目标IP的主机上，然后该主机开始解析接收到的包。
8.  经过物理层、数据链路层、网络层、传输层以及应用层等将就收到的包层层拆开，最终将数据发送给了目标应用软件。